%%% DOCUMENTCLASS 
%%%-------------------------------------------------------------------------------
\documentclass[
a4paper,     % Stock and paper size.
12pt,        % Type size.
%article,
%oneside, 
onecolumn,   % Only one column of text on a page.
% openright, % Each chapter will start on a recto page.
% openleft,  % Each chapter will start on a verso page.
openany,     % A chapter may start on either a recto or verso page.
]{memoir}



%%% PACKAGES 
%%%------------------------------------------------------------------------------
% If utf8 encoding
\usepackage[utf8]{inputenc} 

% If not utf8 encoding, then this is probably the way to go
%\usepackage[latin1]{inputenc} 
\usepackage[T1]{fontenc}    
\usepackage{lmodern}

% English please
\usepackage[english]{babel}

% Less badboxes
\usepackage[final]{microtype} 

% Math
\usepackage{amsmath,amssymb,mathtools}

% http://ctan.org/pkg/pifont
\usepackage{pifont}
\newcommand{\cmark}{\ding{51}}
\newcommand{\xmark}{\ding{55}}

% Include figures
\usepackage{graphicx}
\usepackage{makeidx}
\usepackage{import}
\usepackage[]{algorithm2e}
\usepackage{algpseudocode}
\RestyleAlgo{boxruled}

%%% PAGE LAYOUT 
%%%-----------------------------------------------------------------------------
% Left and right margin
\setlrmarginsandblock{0.15\paperwidth}{*}{1} 
% Upper and lower margin
\setulmarginsandblock{0.2\paperwidth}{*}{1}  
\checkandfixthelayout

\newlength\forceindent
\setlength{\forceindent}{\parindent}
\setlength{\parindent}{0cm}
\renewcommand{\indent}{\hspace*{\forceindent}}
\setlength{\parskip}{1em}


%%% SECTIONAL DIVISIONS
%%%------------------------------------------------------------------------------
% Subsections (and higher) are numbered
\maxsecnumdepth{paragraph} 
\setsecnumdepth{paragraph}

\makeatletter 
\makechapterstyle{standard}{
  \setlength{\beforechapskip}{0\baselineskip}
  \setlength{\midchapskip}{1\baselineskip}
  \setlength{\afterchapskip}{8\baselineskip}
  \renewcommand{\chapterheadstart}{\vspace*{\beforechapskip}}
  \renewcommand{\chapnamefont}{\centering\normalfont\Large}
  \renewcommand{\printchaptername}{\chapnamefont \@chapapp}
  \renewcommand{\chapternamenum}{\space}
  \renewcommand{\chapnumfont}{\normalfont\Large}
  \renewcommand{\printchapternum}{\chapnumfont \thechapter}
  \renewcommand{\afterchapternum}{\par\nobreak\vskip \midchapskip}
  \renewcommand{\printchapternonum}{\vspace*{\midchapskip}\vspace*{5mm}}
  \renewcommand{\chaptitlefont}{\centering\bfseries\LARGE}
  \renewcommand{\afterchaptertitle}{\par\nobreak\vskip \afterchapskip}
}
\makeatother

\usepackage{titlesec}
\usepackage{etoolbox}

%\counterwithout{section}{chapter}
%\titleformat*{\section}{\Large\bfseries}
%\patchcmd{\thebibliography}{\chapter*}{\section}{}{}
\chapterstyle{madsen}

\setsecheadstyle{\normalfont\large\bfseries}
\setsubsecheadstyle{\normalfont\normalsize\bfseries}
\setparaheadstyle{\normalfont\normalsize\bfseries}
\setparaindent{0pt}\setafterparaskip{0pt}

%%% FLOATS AND CAPTIONS
%%%------------------------------------------------------------------------------
\newcommand{\fig}[1]{figure~{\ref{#1}}\xspace}
\newcommand{\tab}[1]{table~{\ref{#1}}\xspace}
\newcommand{\lista}[1]{listing~{\ref{#1}}\xspace}
\newcommand{\parte}[1]{part~{\ref{#1}}\xspace}
\newcommand{\chap}[1]{chapter~{\ref{#1}}\xspace}
\newcommand{\sect}[1]{section~{\ref{#1}}\xspace}

% A space between caption name and text
\captiondelim{\space}
% Font of the caption name
\captionnamefont{\small\bfseries}
% Font of the caption text
\captiontitlefont{\small\normalfont}

% Change the width of the caption
\changecaptionwidth        
\captionwidth{1\textwidth} 

\usepackage{tabularx}
%\usepackage{float}


%%% ABSTRACT
%%%------------------------------------------------------------------------------
% Font of abstract title
\renewcommand{\abstractnamefont}{\normalfont\small\bfseries}
% Width of abstract 
\setlength{\absleftindent}{0.1\textwidth} 
\setlength{\absrightindent}{\absleftindent}



%%% HEADER AND FOOTER 
%%%------------------------------------------------------------------------------
% Make standard pagestyle
\makepagestyle{standard}

% Define standard pagestyle
\makeatletter
\makeevenfoot{standard}{}{}{}
\makeoddfoot{standard}{}{}{}
\makeevenhead{standard}{\bfseries\thepage\normalfont\qquad\small\leftmark}{}{}
\makeoddhead{standard}{}{}{\small\rightmark\qquad\bfseries\thepage}
\makeatother

\makeatletter
\makepsmarks{standard}{
\createmark{chapter}{both}{shownumber}{\@chapapp\ }{ \quad }
\createmark{section}{right}{shownumber}{}{ \quad }
\createplainmark{toc}{both}{\contentsname}
\createplainmark{lof}{both}{\listfigurename}
\createplainmark{lot}{both}{\listtablename}
\createplainmark{bib}{both}{\bibname}
\createplainmark{index}{both}{\indexname}
\createplainmark{glossary}{both}{\glossaryname}
}
\makeatother

% Make new chapter pagestyle
\makepagestyle{chap}

\makeatletter
% Define new chapter pagestyle
\makeevenfoot{chap}{}{\small\bfseries\thepage}{}
\makeoddfoot{chap}{}{\small\bfseries\thepage}{}
\makeevenhead{chap}{}{}{}
\makeoddhead{chap}{}{}{}
\makeatother

\nouppercaseheads
% Choosing pagestyle and chapter pagestyle
\pagestyle{standard}
\aliaspagestyle{chapter}{chap} 



%%% NEW COMMANDS
%%%-----------------------------------------------------------------------------

% Nektar++ version
\usepackage{xspace}
\ifdefined\HCode
\newcommand{\version}{0.1.0\unskip}
\else
\newcommand{\version}{\input{../VERSION.tex}\unskip}
\fi
\addto\captionsenglish{\renewcommand{\chaptername}{Chapter}}

% Partial
\newcommand{\p}{\partial}



%%% CODE SNIPPETS, COMMANDS, ETC
%%%-----------------------------------------------------------------------------
\usepackage{xcolor}
\usepackage{tikz}
\definecolor{gray}{rgb}{0.4,0.4,0.4}
\definecolor{lightgray}{rgb}{0.9,0.9,0.9}
\definecolor{darkblue}{rgb}{0.0,0.0,0.6}
\definecolor{cyan}{rgb}{0.0,0.6,0.6}
\definecolor{maroon}{rgb}{0.5,0.0,0.0}
\definecolor{darkgreen}{rgb}{0.0,0.5,0.0}

% Display code / shell commands
\usepackage{listings}
\usepackage{lstautogobble}


% Bash input style
\lstdefinestyle{BashStyle}
{
  language=bash,
  basicstyle=\footnotesize\ttfamily,
%numbers=left,
%numberstyle=\tiny,
%numbersep=3pt,
  frame=single,
  columns=fullflexible,
  backgroundcolor=\color{yellow!10},
  linewidth=\linewidth,
  xleftmargin=0.05\linewidth,
  keepspaces=true,
  framesep=5pt,
  rulecolor=\color{black!30},
  aboveskip=10pt,
  autogobble=true
}


% XML input style definition
\lstdefinelanguage{XML}
{
  basicstyle=\ttfamily\footnotesize,
  morestring=[b]",
  moredelim=[s][\bfseries\color{maroon}]{<}{\ },
  moredelim=[s][\bfseries\color{maroon}]{</}{>},
  moredelim=[l][\bfseries\color{maroon}]{/>},
  moredelim=[l][\bfseries\color{maroon}]{>},
  morecomment=[s]{<?}{?>},
  morecomment=[s]{<!--}{-->},
  commentstyle=\color{gray},
  stringstyle=\color{orange},
  identifierstyle=\color{darkblue},
  showstringspaces=false
}


% XML input style
\lstdefinestyle{XMLStyle}
{
  language=make,
  basicstyle=\ttfamily\footnotesize,
  numbers=left,
  numberstyle=\tiny,
  numbersep=3pt,
  frame=,
  columns=fullflexible,
  backgroundcolor=\color{black!05},
  linewidth=\linewidth,
  xleftmargin=0.05\linewidth,
  keepspaces=true
}
\lstset{
    escapeinside={(*}{*)},
}


\lstdefinestyle{CStyle}{
  belowcaptionskip=1\baselineskip,
  breaklines=true,
  frame=single,
  escapeinside={\%*}{*)},
  xleftmargin=\parindent,
  language=C,
  captionpos=b,
  keepspaces=true,
  backgroundcolor=\color{black!05},
  showstringspaces=false,
  numbers=left,
  numbersep=5pt,
  numberstyle=\tiny\color{black},
  basicstyle=\scriptsize\ttfamily,
  keywordstyle=\bfseries\color{green!40!black},
  commentstyle=\itshape\color{purple!40!black},
  identifierstyle=\color{blue},
  stringstyle=\color{orange},
  tabsize=4
}

\lstdefinestyle{CStyleNoLine}{
  belowcaptionskip=1\baselineskip,
  breaklines=true,
  frame=single,
  escapeinside={\%*}{*)},
  xleftmargin=\parindent,
  language=C,
  captionpos=b,
  keepspaces=true,
  backgroundcolor=\color{black!05},
  showstringspaces=false,
  basicstyle=\scriptsize\ttfamily,
  keywordstyle=\bfseries\color{green!40!black},
  commentstyle=\itshape\color{purple!40!black},
  identifierstyle=\color{blue},
  stringstyle=\color{orange},
  tabsize=4
}


\lstdefinestyle{FStyle}{
  belowcaptionskip=1\baselineskip,
  breaklines=true,
  frame=single,
  escapeinside={\%*}{*)},
  xleftmargin=\parindent,
  language=[90]Fortran,
  captionpos=b,
  keepspaces=true,
  backgroundcolor=\color{red!05},
  showstringspaces=false,
  numbers=left,
  numbersep=5pt,
  numberstyle=\tiny\color{black},
  basicstyle=\scriptsize\ttfamily,
  keywordstyle=\bfseries\color{red!40!black},
  commentstyle=\itshape\color{green!40!black},
  identifierstyle=\color{blue},
  stringstyle=\color{orange},
  tabsize=4
}

\lstdefinestyle{FStyleNoLine}{
  belowcaptionskip=1\baselineskip,
  breaklines=true,
  frame=single,
  escapeinside={\%*}{*)},
  xleftmargin=\parindent,
  language=[90]Fortran,
  captionpos=b,
  keepspaces=true,
  backgroundcolor=\color{red!05},
  showstringspaces=false,
  basicstyle=\scriptsize\ttfamily,
  keywordstyle=\bfseries\color{red!40!black},
  commentstyle=\itshape\color{green!40!black},
  identifierstyle=\color{blue},
  stringstyle=\color{orange},
  tabsize=4
}

% Inline commands for C++ and Fortran
\ifdefined\HCode
\newcommand{\inltc}[1]{\texttt{#1}}
\newcommand{\inltf}[1]{\texttt{#1}}
\else
\newcommand{\inltc}[1]{\tikz[anchor=base,baseline]\node[inner sep=2pt,
outer sep=0,fill=black!05,text=black]{\small\texttt{#1}};}
\newcommand{\inltf}[1]{\tikz[anchor=base,baseline]\node[inner sep=2pt,
outer sep=0,fill=red!05,text=black]{\small\texttt{#1}};}
\fi


% Inline commands for general words
\ifdefined\HCode
\newcommand{\inlsh}[1]{\texttt{#1}}
\else
\newcommand{\inlsh}[1]{\tikz[anchor=base,baseline]\node[inner sep=2pt,
outer sep=0,draw=yellow!10,fill=yellow!10]{\texttt{#1}};}
\fi

% double-dash
\newcommand \ddash{-\hspace{0.07em}-}

% Atlas
\newcommand{\Atlas}{{\em Atlas}\xspace}



% Highlight box
\usepackage{environ}
\usepackage[tikz]{bclogo}
\usetikzlibrary{calc}

% Only use fancy boxes for PDF
\ifdefined\HCode
\NewEnviron{notebox}{\textbf{Note:} \BODY}
\NewEnviron{warningbox}{\textbf{Warning:} \BODY}
\NewEnviron{tipbox}{\textbf{Tip:} \BODY}
\NewEnviron{custombox}[3]{\textbf{#1} \BODY}
\else
\NewEnviron{notebox}
  {\par\medskip\noindent
  \begin{tikzpicture}
    \node[inner sep=5pt,fill=black!10,draw=black!30] (box)
    {\parbox[t]{.99\linewidth}{%
      \begin{minipage}{.1\linewidth}
      \centering\tikz[scale=1]\node[scale=1.5]{\bcinfo};
      \end{minipage}%
      \begin{minipage}{.85\linewidth}
      \textbf{Note}\par\smallskip
      \BODY
      \end{minipage}\hfill}%
    };
   \end{tikzpicture}\par\medskip%
}
\NewEnviron{warningbox}
  {\par\medskip\noindent
  \begin{tikzpicture}
    \node[inner sep=5pt,fill=red!10,draw=black!30] (box)
    {\parbox[t]{.99\linewidth}{%
      \begin{minipage}{.1\linewidth}
      \centering\tikz[scale=1]\node[scale=1.5]{\bcdanger};
      \end{minipage}%
      \begin{minipage}{.85\linewidth}
      \textbf{Warning}\par\smallskip
      \BODY
      \end{minipage}\hfill}%
    };
   \end{tikzpicture}\par\medskip%
}
\NewEnviron{tipbox}
  {\par\medskip\noindent
  \begin{tikzpicture}
    \node[inner sep=5pt,fill=green!10,draw=black!30] (box)
    {\parbox[t]{.99\linewidth}{%
      \begin{minipage}{.1\linewidth}
      \centering\tikz[scale=1]\node[scale=1.5]{\bclampe};
      \end{minipage}%
      \begin{minipage}{.85\linewidth}
      \textbf{Tip}\par\smallskip
      \BODY
      \end{minipage}\hfill}%
    };
   \end{tikzpicture}\par\medskip%
}
\NewEnviron{custombox}[3]
  {\par\medskip\noindent
  \begin{tikzpicture}
    \node[inner sep=5pt,fill=#3!10,draw=black!30] (box)
    {\parbox[t]{.99\linewidth}{%
      \begin{minipage}{.1\linewidth}
      \centering\tikz[scale=1]\node[scale=1.5]{#2};
      \end{minipage}%
      \begin{minipage}{.85\linewidth}
      \textbf{#1}\par\smallskip
      \BODY
      \end{minipage}\hfill}%
    };
   \end{tikzpicture}\par\medskip%
}
\fi



%%% TABLE OF CONTENTS AND INDEX
%%%-----------------------------------------------------------------------------


\makeindex


%%% INTERNAL HYPERLINKS
%%%-----------------------------------------------------------------------------
% Internal hyperlinks
\usepackage[linktoc=all,hyperfootnotes=false]{hyperref}
\hypersetup{
colorlinks,
citecolor=darkblue,
filecolor=darkblue,
linkcolor=darkblue,
urlcolor=darkblue,
% No borders around internal hyperlinks
pdfborder={0 0 0},
% Author
pdfauthor={I am the Author}
}
\usepackage{memhfixc}


%%% PRETTY TITLE PAGE FOR PDF DOC
%%%-----------------------------------------------------------------------------
\ifdefined\HCode
\else
\makeatletter
\newlength\drop
\newcommand{\br}{\hfill\break}
\newcommand*{\titlepage}{
    \thispagestyle{empty}
    % Gentle Madness
    \begingroup
    \drop = 0.1\textheight
    \vspace*{\baselineskip}
    \vfill
    \hbox{
      \hspace*{0.1\textwidth}
      \rule{1pt}{\dimexpr\textheight-28pt\relax}
      \hspace*{0.05\textwidth}
      \parbox[b]{0.85\textwidth}{
        \vbox{
          \vspace{\drop}
          {\Huge\bfseries\raggedright\@title\par}
          \vskip1.10\baselineskip
          {\Large\bfseries Version \version\par}
          \vskip4\baselineskip
          {\huge\bfseries \textcolor{darkgreen}{Documentation}\par}
          \vskip1.0\baselineskip
          {\large\bfseries\@date\par}
          \vspace{0.2\textheight}
          {\small\noindent\@author}\\[\baselineskip]
        }% end of vbox
      }% end of parbox
    }% end of hbox
    \vfill
    \null
\endgroup}
\makeatother
\fi



%%% THE DOCUMENT
%%%-------------------------------------------------------------------------------
\author{ECMWF, Shinfield Park, Reading, UK\newline}
\title{Dwarf 3: Cloud Scheme}
\date{\today}


\begin{document}

\frontmatter

% Render pretty title page if not building HTML
\ifdefined\HCode
\maketitle
\begin{center}
    \huge{Version \version}
\end{center}
\else
\titlepage
\fi

\clearpage

\ifx\HCode\undefined
\tableofcontents*
\fi

\clearpage

\mainmatter


\chapter{Scope and Objectives}
In this chapter, we briefly identify the scope of dwarf 3 
by outlining the motivations behind its implementation and 
we present the main objectives we want to achieve.

\section{Broad scope}
TBC

\section{Objectives}
TBC



\chapter{Definition of the Dwarf}
Dwarf 3 aims to test the cloud microphysics.

TBC


\chapter{Dwarf Usage}
In this chapter we describe how to download and install 
the dwarf along with all its dependencies and we show 
how to run it for a simple test case.



\section{Download and installation}
The first step is to download and install the dwarf along 
with all its dependencies. With this purpose, it is possible 
to use the script provided under the ESCAPE software collaboration 
platform:\\
\url{https://software.ecmwf.int/stash/projects/ESCAPE}.

Here you can find a repository called \inlsh{escape}.
You need to download it. You could first create a 
folder named, for instance, ESCAPE, enter into it 
and subsequently download the repository. 
This can be done following the steps below:
%
\begin{lstlisting}[style=BashStyle]
mkdir ESCAPE
cd ESCAPE/
git clone ssh://git@software.ecmwf.int:7999/escape/escape.git
\end{lstlisting}
%
Once downloaded the repository into the \inlsh{ESCAPE} folder 
just created, you should find a new folder called \inlsh{escape}. 
The folder contains a sub-folder called \inlsh{bin} that has the 
python/bash script (called \inlsh{escape}) that needs to be 
run for downloading and installing the dwarf and its dependencies. 
To see the various options provided by the script you can type:
%
\begin{lstlisting}[style=BashStyle]
./escape/bin/escape -h
\end{lstlisting}
%
To download the dwarf and its dependencies you need to run 
the following command:
%
\begin{lstlisting}[style=BashStyle]
./escape/bin/escape checkout dwarf3-cloudscheme --ssh
\end{lstlisting}
% 
Note the option \inlsh{--ssh}. This can be used only internally 
at ECMWF for the moment. If you are an external project partner
you should use the following command instead:
%
\begin{lstlisting}[style=BashStyle]
./escape/bin/escape checkout dwarf3-cloudscheme --user <username>
\end{lstlisting}
% 
and follow the instructions. 
The commands above automatically check out the \inlsh{develop}
version of the dwarf. If you want to download a specific branch 
of this dwarf, you can do so by typing:
%
\begin{lstlisting}[style=BashStyle]
./escape/bin/escape checkout dwarf3-cloudscheme --ssh \
--version <branch-name>
\end{lstlisting}
% 
Analogous approach can be used for the \inlsh{-\,-user} 
version of the command. You should now have a folder called 
\inlsh{dwarf3-cloudscheme}.

In the above command, you can specify several other optional 
parameters. To see all these options and how to use them you 
can type the following command:
%
\begin{lstlisting}[style=BashStyle]
./escape checkout -h
\end{lstlisting}
%

At this stage it is possible to install the dwarf 
and all its dependencies. This can be done in two 
different ways. The first way is to compile and 
install each dependency and the dwarf separately:
%
\begin{lstlisting}[style=BashStyle]
./escape/bin/escape generate_install dwarf3-cloudscheme
\end{lstlisting}
% 
The command above will generate a script 
called \inlsh{install-dwarf3-cloudscheme} 
that can be run by typing:
%
\begin{lstlisting}[style=BashStyle]
./install-dwarf3-cloudscheme
\end{lstlisting}
%
This last step will build and install the dwarf 
along with all its dependencies in the following 
paths:
%
\begin{lstlisting}[style=BashStyle]
dwarf3-cloudscheme/builds/
dwarf3-cloudscheme/install/
\end{lstlisting}
%

The second way is to create a bundle that compile 
and install all the dependencies together:
%
\begin{lstlisting}[style=BashStyle]
./escape/bin/escape generate_bundle dwarf3-cloudscheme
\end{lstlisting}
% 
This command will create an infrastructure to avoid
compiling the single third-party libraries individually
when some modifications are applied locally to one of 
them. To complete the compilation and installation process, 
after having run the above command for the bundle, simply 
follow the instructions on the terminal.

In the commands above that generate the installation 
file, you can specify several other optional parameters. 
To see all these options and how to use them you 
can type the following command:
%
\begin{lstlisting}[style=BashStyle]
./escape generate-install -h
./escape generate-bundle -h
\end{lstlisting}
%

\subsection{Testing}
You should now verify that the dwarf works as expected.
With this purpose, we created a testing framework that
allows us to verify that the main features of the dwarf 
are working correctly.

To run this verification, you should run the following 
command:
%
\begin{lstlisting}[style=BashStyle]
ctest -j<number-of-tasks>
\end{lstlisting}
%
from inside the \inlsh{builds/dwarf3-cloudscheme}
folder.
%
\begin{warningbox}
We strongly advise you to verify via ctest that 
the main functionalities of the dwarf are working 
properly any time you apply modifications to the 
code. Updates that do not pass the tests cannot 
be merged. 
In addition, if you add a new feature to the dwarf,
this should be supported by a test if the existing
testing framework is not already able to verify its
functionality.
\end{warningbox}
%
If you encounter any problem in the installation 
procedure, please contact either Gianmarco Mengaldo 
(\url{gianmarco.mengaldo@ecmwf.int}) or Willem 
Deconinck (\url{willem.deconinck@ecmwf.int}).

For instructions on how to run the executables 
see the next section.



\section{Run the dwarf}
TBC

\cite{Eisenstat1983} 



\backmatter

%%% BIBLIOGRAPHY
%%% -------------------------------------------------------------

\bibliographystyle{plain}
\bibliography{refs}


\end{document}
